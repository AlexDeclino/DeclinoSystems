<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ALEX DECLINO</title>
  <style>
    * {
      font-family: monospace;
      padding: 0;
      line-height: 1.3rem;
    }

    body {
      margin: 8px;
      background-color: #ffffff;
      color: #111111;
    }

    h2 {
      margin-left: 0.83em;
    }

    .quote-line {
      margin-left: calc(2 * 0.83em);
      font-size: 0.85rem;
      color: #666;
    }

    a {
      color: red;
    }

    a:visited {
      color: #990000;
    }

    #dice {
      cursor: pointer;
      color: red;
    }

    #frame {
      position: relative;
      width: 400px;
      height: 400px;
      background: #111;
      overflow: hidden;
      margin-top: 0.25rem;
      margin-left: calc(2 * 0.83em);
      max-width: calc(100vw - 3em);
      aspect-ratio: 1;
    }

    @media (max-width: 480px) {
      h2 {
        margin-left: 0.5em;
      }
      .quote-line {
        margin-left: 1em;
        margin-right: 1em;
      }
      #frame {
        width: calc(100vw - 2em);
        height: auto;
        margin-left: 1em;
      }
      #dither {
        width: 100%;
        height: 100%;
      }
    }

    #frame img {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: fill;
      opacity: 0;
      transition: opacity 0.5s ease;
      filter: saturate(5) contrast(2.5) brightness(1.2) hue-rotate(-15deg);
    }

    #frame img.active {
      opacity: 1;
    }

    #dither {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 1;
    }

    @media (prefers-color-scheme: dark) {
      body {
        background-color: #111111;
        color: #eeeeee;
      }
      #frame {
        background: #222;
      }
      .quote-line {
        color: #888;
      }
    }

    @media (prefers-color-scheme: light) {
      body {
        background-color: #ffffff;
        color: #111111;
      }
    }
  </style>
</head>
<body>
  <h2>ALEX DECLINO</h2>
  <div class="quote-line"><span id="quote"></span> <span id="dice" onclick="loadQuote()">[ê©œ]</span></div>

  <div id="frame">
    <img id="img1" src="" alt="" crossorigin="anonymous">
    <img id="img2" src="" alt="" crossorigin="anonymous">
    <canvas id="dither" width="400" height="400"></canvas>
  </div>

  <script src="config.js"></script>
  <script>
    const API_URL = `https://api.are.na/v2/channels/${CHANNEL_SLUG}?per=100`;
    const QUOTES_API = 'https://api.are.na/v2/channels/npc-dialogues?per=100';

    let images = [];
    const img1 = document.getElementById('img1');
    const img2 = document.getElementById('img2');
    const ditherCanvas = document.getElementById('dither');
    const ditherCtx = ditherCanvas.getContext('2d');
    const sampleCanvas = document.createElement('canvas');
    const sampleCtx = sampleCanvas.getContext('2d');
    sampleCanvas.width = 400;
    sampleCanvas.height = 400;
    let current = 1;

    async function init() {
      try {
        const response = await fetch(API_URL);
        if (!response.ok) throw new Error('Failed to fetch');

        const data = await response.json();
        images = data.contents.filter(block => block.class === 'Image');

        if (images.length === 0) return;

        // preload
        images.forEach(block => {
          const preload = new Image();
          preload.crossOrigin = 'anonymous';
          preload.src = block.image.display.url;
        });

        showRandom();
        setInterval(showRandom, 200);

      } catch (error) {
        console.error(error);
      }
    }

    function drawDither(imgEl) {
      ditherCtx.clearRect(0, 0, 400, 400);
      ditherCtx.fillStyle = 'rgba(0, 0, 0, 0.4)';

      try {
        sampleCtx.drawImage(imgEl, 0, 0, 400, 400);
        const imageData = sampleCtx.getImageData(0, 0, 400, 400);
        const pixels = imageData.data;

        const lineSpacing = 6;
        for (let y = 0; y < 400; y += lineSpacing) {
          for (let x = 0; x < 400; x += 3) {
            const i = (y * 400 + x) * 4;
            const brightness = (pixels[i] + pixels[i+1] + pixels[i+2]) / 3;
            const lineHeight = Math.floor((1 - brightness / 255) * (lineSpacing - 1)) + 1;
            ditherCtx.fillRect(x, y, 3, lineHeight);
          }
        }
      } catch (e) {
        // CORS fallback - just draw regular scan lines
        for (let y = 0; y < 400; y += 4) {
          ditherCtx.fillRect(0, y, 400, 2);
        }
      }
    }

    function showRandom() {
      const block = images[Math.floor(Math.random() * images.length)];
      if (current === 1) {
        img2.src = block.image.display.url;
        img2.onload = () => {
          img1.classList.remove('active');
          img2.classList.add('active');
          drawDither(img2);
          current = 2;
        };
      } else {
        img1.src = block.image.display.url;
        img1.onload = () => {
          img2.classList.remove('active');
          img1.classList.add('active');
          drawDither(img1);
          current = 1;
        };
      }
    }

    async function loadQuote() {
      try {
        const response = await fetch(QUOTES_API);
        if (!response.ok) return;
        const data = await response.json();
        const texts = data.contents.filter(block => block.class === 'Text');
        if (texts.length === 0) return;
        const random = texts[Math.floor(Math.random() * texts.length)];
        document.getElementById('quote').textContent = `"${random.content}"`;
      } catch (error) {
        console.error(error);
      }
    }

    init();
    loadQuote();
  </script>
</body>
</html>
